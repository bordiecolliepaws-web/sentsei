<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentsei ‚Äî Learn by Saying</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='74'%3E%E5%AD%B8%3C/text%3E%3C/svg%3E">
    <style>
        :root {
            --bg: #0c0c0c;
            --surface: #161616;
            --surface2: #1e1e1e;
            --border: #2a2a2a;
            --text: #f0ece4;
            --text-dim: #908a7e;
            --accent: #e8a838;
            --accent-glow: rgba(232, 168, 56, 0.12);
            --easy: #6dcf8c;
            --medium: #e8a838;
            --hard: #e85d5d;
            --radius: 14px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 720px;
            padding: 2rem 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        header h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--accent), #f0c96e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            color: var(--text-dim);
            margin-top: 0.5rem;
            font-size: 0.95rem;
        }

        .input-area {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .language-select {
            margin-bottom: 1rem;
        }

        .language-select label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 600;
            display: block;
            margin-bottom: 0.5rem;
        }

        .lang-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            padding-bottom: 2px;
        }

        .lang-pill {
            background: var(--surface2);
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.4rem 0.75rem;
            font-size: 0.82rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-family: inherit;
        }

        .lang-pill:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .lang-pill.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .lang-pill .flag {
            font-size: 1rem;
            line-height: 1;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.65rem;
        }

        .toggle-row label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 600;
            min-width: 72px;
            flex-shrink: 0;
        }

        .toggle-pills {
            display: flex;
            gap: 0.3rem;
        }

        .toggle-pill {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.25rem 0.6rem;
            font-size: 0.72rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-family: inherit;
        }

        .toggle-pill:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .toggle-pill.active {
            border-color: var(--accent);
            color: var(--accent);
        }

        .sentence-input {
            display: flex;
            gap: 0.75rem;
        }

        .sentence-input-actions {
            display: flex;
            flex-direction: column;
            gap: 0.55rem;
            min-width: 152px;
        }

        .sentence-input textarea {
            flex: 1;
            background: var(--surface2);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            resize: none;
            outline: none;
            font-family: inherit;
            min-height: 52px;
            max-height: 120px;
        }

        .sentence-input textarea:focus {
            border-color: var(--accent);
        }

        .sentence-input textarea::placeholder {
            color: var(--text-dim);
        }

        .sentence-input button {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 1.1rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            min-height: 52px;
        }

        .sentence-input .surprise-btn {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .sentence-input .surprise-btn:hover {
            filter: none;
            background: var(--accent-glow);
        }

        .sentence-input .surprise-btn:disabled {
            border-color: var(--border);
            color: var(--text-dim);
            background: transparent;
        }

        .sentence-input button:hover {
            filter: brightness(1.15);
            transform: translateY(-1px);
        }

        .sentence-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .input-hint {
            margin-top: 0.65rem;
            font-size: 0.78rem;
            color: var(--text-dim);
        }

        .sentence-history-wrap {
            margin-top: 1rem;
        }

        .sentence-history-title {
            font-size: 0.76rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            font-weight: 600;
        }

        .sentence-history {
            display: flex;
            flex-wrap: wrap;
            gap: 0.45rem;
        }

        .history-chip {
            max-width: 100%;
            background: var(--surface2);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.38rem 0.68rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-chip:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        /* History Panel */
        .history-toggle-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 25;
            background: var(--surface);
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.5rem 0.75rem;
            font-size: 0.82rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-family: inherit;
        }

        .history-toggle-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .history-toggle-btn .badge {
            background: var(--accent);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            border-radius: 99px;
            padding: 0.1rem 0.4rem;
            min-width: 1.1rem;
            text-align: center;
        }

        .history-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            height: 100vh;
            background: var(--surface);
            border-left: 1px solid var(--border);
            z-index: 20;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .history-panel.open {
            transform: translateX(0);
        }

        .history-panel-header {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .history-panel-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .history-panel-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.3rem;
            cursor: pointer;
            padding: 0.2rem;
            line-height: 1;
            transition: color 0.2s;
        }

        .history-panel-close:hover {
            color: var(--text);
        }

        .history-panel-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .history-panel-empty {
            padding: 2rem 1rem;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .history-panel-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid rgba(42, 42, 62, 0.5);
        }

        .history-panel-item:hover {
            background: var(--surface2);
        }

        .history-panel-item .hp-sentence {
            font-size: 0.85rem;
            color: var(--text);
            margin-bottom: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-panel-item .hp-translation {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-panel-item .hp-meta {
            font-size: 0.7rem;
            color: var(--text-dim);
            display: flex;
            gap: 0.5rem;
        }

        .history-panel-item .hp-lang {
            color: var(--accent);
            font-weight: 500;
        }

        .history-panel-clear {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .history-panel-export {
            display: flex;
            gap: 0.45rem;
            margin-bottom: 0.6rem;
        }

        .history-panel-export .toggle-pill {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
            padding: 0.45rem 0.6rem;
            font-size: 0.74rem;
        }

        .history-panel-export .toggle-pill:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .history-panel-clear #history-clear-btn {
            width: 100%;
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem;
            font-size: 0.78rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .history-panel-clear #history-clear-btn:hover {
            border-color: #f87171;
            color: #f87171;
        }

        .history-overlay {
            position: fixed;
            inset: 0;
            background: rgba(6, 6, 10, 0.5);
            z-index: 19;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .history-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        /* Stories + Quiz actions */
        .header-left-actions {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 25;
            display: flex;
            align-items: center;
            gap: 0.45rem;
        }

        .stories-toggle-btn,
        .quiz-toggle-btn {
            background: var(--surface);
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.5rem 0.75rem;
            font-size: 0.82rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-family: inherit;
            white-space: nowrap;
        }

        .stories-toggle-btn:hover,
        .quiz-toggle-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .quiz-toggle-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }

        .stories-toggle-btn .badge {
            background: var(--accent);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            border-radius: 99px;
            padding: 0.1rem 0.4rem;
            min-width: 1.1rem;
            text-align: center;
        }

        .stories-overlay {
            position: fixed;
            inset: 0;
            background: rgba(6, 6, 10, 0.5);
            z-index: 19;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .stories-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .stories-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 340px;
            height: 100vh;
            background: var(--surface);
            border-right: 1px solid var(--border);
            z-index: 20;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .stories-panel.open {
            transform: translateX(0);
        }

        .stories-panel-header {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .stories-panel-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .stories-panel-content {
            flex: 1;
            overflow-y: auto;
        }

        .stories-browser {
            padding: 0.8rem 0;
        }

        .stories-filter {
            padding: 0 1rem 0.7rem;
            color: var(--text-dim);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .stories-list {
            display: flex;
            flex-direction: column;
        }

        .stories-empty {
            padding: 1.2rem 1rem;
            color: var(--text-dim);
            font-size: 0.84rem;
            text-align: center;
        }

        .story-list-item {
            background: transparent;
            color: var(--text);
            border: none;
            border-top: 1px solid rgba(42, 42, 62, 0.5);
            border-bottom: 1px solid rgba(42, 42, 62, 0.5);
            margin-top: -1px;
            text-align: left;
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            font-family: inherit;
        }

        .story-list-item:hover {
            background: var(--surface2);
        }

        .story-list-title {
            font-size: 0.92rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .story-list-meta {
            display: flex;
            justify-content: space-between;
            gap: 0.45rem;
            font-size: 0.73rem;
            color: var(--text-dim);
        }

        .story-list-progress {
            color: var(--accent);
            font-weight: 500;
        }

        .story-reader {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }

        .story-reader-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.9rem;
        }

        .story-back-btn {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.4rem 0.6rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .story-back-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .story-progress {
            color: var(--accent);
            font-size: 0.78rem;
            font-weight: 600;
        }

        .story-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }

        .story-source {
            font-size: 0.78rem;
            color: var(--text-dim);
            margin-bottom: 0.95rem;
        }

        .story-sentence {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.95rem;
            font-size: 1.05rem;
            line-height: 1.5;
            min-height: 110px;
            margin-bottom: 1rem;
        }

        .story-nav {
            margin-top: auto;
            display: flex;
            gap: 0.55rem;
        }

        .story-nav button {
            flex: 1;
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.62rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .story-nav button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .story-nav button:disabled {
            opacity: 0.45;
            cursor: not-allowed;
            color: var(--text-dim);
            border-color: var(--border);
        }

        /* Quiz Mode */
        .quiz-mode .input-area {
            display: none;
        }

        .quiz-area {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.1rem;
            margin-bottom: 1.4rem;
            animation: fadeIn 0.3s ease;
        }

        .quiz-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.8rem;
            margin-bottom: 0.85rem;
        }

        .quiz-title {
            font-size: 0.96rem;
            font-weight: 650;
        }

        .quiz-meta {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.12rem;
        }

        .quiz-score {
            font-size: 0.76rem;
            color: var(--accent);
            background: var(--accent-glow);
            border: 1px solid rgba(232, 168, 56, 0.3);
            border-radius: 999px;
            padding: 0.3rem 0.62rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .quiz-card {
            background: linear-gradient(180deg, rgba(232, 168, 56, 0.06), rgba(0, 0, 0, 0) 35%), var(--surface2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
        }

        .quiz-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            margin-bottom: 0.6rem;
        }

        .quiz-sentence {
            font-size: 1.18rem;
            font-weight: 650;
            line-height: 1.5;
            margin-bottom: 0.3rem;
        }

        .quiz-pronunciation {
            color: var(--accent);
            font-size: 0.86rem;
            margin-bottom: 0.22rem;
        }

        .quiz-source {
            color: var(--text-dim);
            font-size: 0.76rem;
            margin-bottom: 0.55rem;
        }

        .quiz-hint {
            font-size: 0.8rem;
            color: var(--text);
            margin-bottom: 0.8rem;
        }

        .quiz-answer-row {
            display: flex;
            gap: 0.55rem;
            align-items: center;
        }

        .quiz-answer-input {
            flex: 1;
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.62rem 0.72rem;
            font-family: inherit;
            font-size: 0.95rem;
            outline: none;
        }

        .quiz-answer-input:focus {
            border-color: var(--accent);
        }

        .quiz-check-btn {
            background: var(--accent);
            color: #111;
            border: none;
            border-radius: 8px;
            padding: 0.62rem 0.95rem;
            font-size: 0.88rem;
            font-weight: 650;
            cursor: pointer;
            transition: filter 0.2s;
            font-family: inherit;
            white-space: nowrap;
        }

        .quiz-check-btn:hover {
            filter: brightness(1.12);
        }

        .quiz-check-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .quiz-result {
            margin-top: 0.72rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface);
            padding: 0.72rem 0.8rem;
            opacity: 0;
            transform: translateY(8px);
        }

        .quiz-result.show {
            animation: quizReveal 0.34s ease forwards;
        }

        .quiz-result.perfect {
            border-color: rgba(109, 207, 140, 0.45);
            background: rgba(109, 207, 140, 0.08);
        }

        .quiz-result.good {
            border-color: rgba(232, 168, 56, 0.45);
            background: rgba(232, 168, 56, 0.09);
        }

        .quiz-result.partial {
            border-color: rgba(240, 186, 88, 0.34);
            background: rgba(240, 186, 88, 0.08);
        }

        .quiz-result.wrong {
            border-color: rgba(232, 93, 93, 0.45);
            background: rgba(232, 93, 93, 0.08);
        }

        .quiz-result-head {
            font-size: 0.92rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }

        .quiz-result-answer {
            font-size: 0.82rem;
            color: var(--text);
            margin-bottom: 0.15rem;
            line-height: 1.45;
        }

        .quiz-result-feedback {
            font-size: 0.8rem;
            color: var(--text-dim);
            line-height: 1.45;
        }

        .quiz-actions {
            margin-top: 0.78rem;
            display: flex;
            gap: 0.55rem;
        }

        .quiz-next-btn,
        .quiz-exit-btn {
            flex: 1;
            border-radius: 8px;
            padding: 0.58rem 0.72rem;
            font-size: 0.82rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quiz-next-btn {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .quiz-next-btn:hover {
            background: var(--accent-glow);
        }

        .quiz-exit-btn {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--border);
        }

        .quiz-exit-btn:hover {
            color: var(--text);
            border-color: var(--accent);
        }

        @keyframes quizReveal {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mobile: bottom drawer instead of side panel */
        @media (max-width: 600px) {
            .history-toggle-btn {
                top: auto;
                bottom: 1rem;
                right: 1rem;
                border-radius: 99px;
                padding: 0.6rem 0.8rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            }

            .header-left-actions {
                top: auto;
                bottom: 1rem;
                left: 1rem;
                gap: 0.42rem;
            }

            .stories-toggle-btn,
            .quiz-toggle-btn {
                border-radius: 99px;
                padding: 0.6rem 0.8rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            }

            .quiz-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.4rem;
            }

            .quiz-answer-row {
                flex-direction: column;
            }

            .quiz-check-btn,
            .quiz-answer-input {
                width: 100%;
            }

            .history-panel {
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 60vh;
                max-height: 60vh;
                border-left: none;
                border-top: 1px solid var(--border);
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
            }

            .history-panel.open {
                transform: translateY(0);
            }

            .stories-panel {
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 62vh;
                max-height: 62vh;
                border-right: none;
                border-top: 1px solid var(--border);
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
            }

            .stories-panel.open {
                transform: translateY(0);
            }
        }

        /* Result Card */
        .result-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-main {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .result-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .result-source {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .copy-btn {
            background: var(--surface2);
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.35rem 0.55rem;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.76rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .copy-btn:hover {
            color: var(--text);
            border-color: var(--accent);
        }

        .copy-btn.copied {
            color: var(--easy);
            border-color: var(--easy);
        }

        .copy-btn svg {
            width: 14px;
            height: 14px;
        }

        .speak-btn {
            background: var(--surface2);
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.35rem 0.55rem;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.76rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .speak-btn:hover {
            color: var(--text);
            border-color: var(--accent);
        }

        .speak-btn.speaking {
            color: var(--accent);
            border-color: var(--accent);
        }

        .result-translation {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            line-height: 1.4;
        }

        .result-pronunciation {
            font-size: 1rem;
            color: var(--accent);
            margin-bottom: 0.3rem;
        }

        .result-literal {
            font-size: 0.85rem;
            color: var(--text-dim);
            font-style: italic;
        }

        .result-formality {
            display: inline-block;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.6rem;
            border-radius: 99px;
            background: var(--accent-glow);
            color: var(--accent);
            font-weight: 500;
        }

        /* Breakdown */
        .breakdown-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-dim);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .word-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .word-chip {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            min-width: 80px;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            position: relative;
        }

        .word-chip:hover {
            border-color: var(--accent);
        }

        .word-chip.expanded {
            border-color: var(--accent);
            background: rgba(124, 106, 255, 0.08);
            grid-column: 1 / -1;
        }

        .word-detail {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
            animation: fadeIn 0.2s ease;
        }

        .word-detail-loading {
            font-size: 0.75rem;
            color: var(--text-dim);
            padding: 0.3rem 0;
        }

        .word-detail-section {
            margin-bottom: 0.5rem;
        }

        .word-detail-section:last-child {
            margin-bottom: 0;
        }

        .word-detail-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-dim);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .word-detail-examples {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .word-detail-examples li {
            font-size: 0.8rem;
            line-height: 1.4;
            color: var(--text);
        }

        .word-detail-examples .example-pron {
            font-size: 0.72rem;
            color: var(--accent);
        }

        .word-detail-examples .example-meaning {
            font-size: 0.72rem;
            color: var(--text-dim);
        }

        .word-detail-conjugations {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
        }

        .conjugation-tag {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.2rem 0.5rem;
            font-size: 0.72rem;
            color: var(--text);
        }

        .conjugation-tag .conj-label {
            color: var(--text-dim);
            font-size: 0.65rem;
        }

        .word-detail-related {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
        }

        .related-word-tag {
            background: var(--accent-glow);
            border-radius: 6px;
            padding: 0.2rem 0.5rem;
            font-size: 0.72rem;
            color: var(--accent);
            cursor: pointer;
        }

        .related-word-tag:hover {
            background: rgba(124, 106, 255, 0.25);
        }

        .word-chip .word-target {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.15rem;
        }

        .word-chip .word-pron {
            font-size: 0.75rem;
            color: var(--accent);
        }

        .word-chip .word-meaning {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.2rem;
        }

        .word-chip .word-note {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 0.3rem;
            padding-top: 0.3rem;
            border-top: 1px solid var(--border);
        }

        .difficulty-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
            vertical-align: middle;
        }

        .difficulty-dot.easy { background: var(--easy); }
        .difficulty-dot.medium { background: var(--medium); }
        .difficulty-dot.hard { background: var(--hard); }

        /* Grammar & Notes */
        .notes-section {
            padding: 1.5rem;
        }

        .grammar-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .grammar-list li {
            font-size: 0.9rem;
            color: var(--text);
            padding-left: 1.2rem;
            position: relative;
            line-height: 1.5;
        }

        .grammar-list li::before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: var(--accent);
        }

        .cultural-note, .alternative-note {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-dim);
            padding: 0.75rem;
            background: var(--accent-glow);
            border-radius: 8px;
            line-height: 1.5;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-dim);
        }

        .loading .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        .loading-message {
            margin-bottom: 0.45rem;
            transition: opacity 0.3s;
        }

        .loading-tip {
            font-size: 0.85rem;
            color: var(--text);
            opacity: 0.92;
        }

        .loading-elapsed {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
            font-variant-numeric: tabular-nums;
        }

        .loading-cancel {
            margin-top: 0.75rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 0.35rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: border-color 0.2s, color 0.2s;
        }
        .loading-cancel:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        /* Error state */
        .error-banner {
            text-align: center;
            padding: 1.5rem;
            background: rgba(220, 80, 60, 0.08);
            border: 1px solid rgba(220, 80, 60, 0.25);
            border-radius: 14px;
            margin-bottom: 1rem;
        }
        .error-banner p {
            color: #dc503c;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }
        .error-banner button {
            background: var(--accent);
            color: #111;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* History */
        .history-divider {
            margin: 1.5rem 0;
        }

        /* Comparison Mode */
        #compare-results {
            margin-bottom: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.95rem;
            animation: fadeIn 0.3s ease;
        }

        .compare-results-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.45rem;
        }

        .compare-results-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-dim);
            font-weight: 600;
        }

        .compare-results-source {
            font-size: 0.9rem;
            color: var(--text);
            line-height: 1.4;
            margin-bottom: 0.8rem;
        }

        .compare-close-btn {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.25rem 0.55rem;
            font-size: 0.78rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            white-space: nowrap;
        }

        .compare-close-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .compare-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.65rem;
        }

        .compare-card {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.7rem 0.75rem;
        }

        .compare-card-lang {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--text-dim);
            font-size: 0.74rem;
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 600;
        }

        .compare-card-lang .flag {
            font-size: 0.9rem;
            line-height: 1;
        }

        .compare-card-translation {
            color: var(--text);
            font-size: 1.12rem;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 0.28rem;
        }

        .compare-card-pronunciation {
            color: var(--accent);
            font-size: 0.84rem;
            line-height: 1.35;
            margin-bottom: 0.24rem;
        }

        .compare-card-literal {
            color: var(--text-dim);
            font-size: 0.78rem;
            line-height: 1.35;
        }

        .compare-empty {
            color: var(--text-dim);
            font-size: 0.84rem;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(6, 6, 10, 0.72);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 30;
            backdrop-filter: blur(2px);
        }

        .modal {
            width: 100%;
            max-width: 380px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: 0 18px 44px rgba(0, 0, 0, 0.45);
        }

        .modal h2 {
            font-size: 1.05rem;
            margin-bottom: 0.45rem;
        }

        .modal p {
            color: var(--text-dim);
            font-size: 0.88rem;
            margin-bottom: 0.9rem;
            line-height: 1.45;
        }

        .password-form {
            display: flex;
            gap: 0.55rem;
        }

        .password-form input {
            flex: 1;
            background: var(--surface2);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.62rem 0.72rem;
            outline: none;
        }

        .password-form input:focus {
            border-color: var(--accent);
        }

        .password-form button {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.6rem 0.95rem;
            font-size: 0.86rem;
            font-weight: 600;
            cursor: pointer;
            transition: filter 0.2s;
        }

        .password-form button:hover {
            filter: brightness(1.1);
        }

        .password-error {
            color: #f0a0a0;
            margin-top: 0.65rem;
            font-size: 0.8rem;
        }

        body.modal-open {
            overflow: hidden;
        }

        .hidden { display: none !important; }

        /* Mobile-first improvements */
        @media (max-width: 600px) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }

            .container {
                padding: 1rem 0.75rem;
            }

            header {
                margin-bottom: 1.25rem;
            }

            header h1 {
                font-size: 1.5rem;
            }

            header p {
                font-size: 0.85rem;
                margin-top: 0.25rem;
            }

            .input-area {
                padding: 1rem;
                margin-bottom: 1rem;
                position: sticky;
                top: 0;
                z-index: 10;
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                background: rgba(20, 20, 31, 0.92);
            }

            .language-select {
                margin-bottom: 0.65rem;
            }

            .sentence-input {
                flex-direction: column;
                gap: 0.5rem;
            }

            .sentence-input-actions {
                flex-direction: row;
                min-width: 0;
                width: 100%;
            }

            .sentence-input button {
                flex: 1;
                padding: 0.75rem;
                font-size: 0.95rem;
                min-height: 46px;
            }

            .sentence-input textarea {
                font-size: 1rem;
            }

            .result-translation {
                font-size: 1.3rem;
            }

            .result-head {
                flex-direction: column;
                gap: 0.5rem;
            }

            .copy-btn {
                align-self: flex-start;
            }

            .word-chips {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .word-chip {
                min-width: unset;
            }

            .result-main,
            .breakdown-section,
            .notes-section {
                padding: 1rem;
            }

            .compare-grid {
                grid-template-columns: 1fr;
            }

            .password-form {
                flex-direction: column;
            }

            .input-hint {
                display: none; /* redundant on mobile ‚Äî button is full-width and obvious */
            }
        }

        /* Small phones */
        @media (max-width: 360px) {
            .container { padding: 0.75rem 0.5rem; }
            .word-chips { grid-template-columns: 1fr; }
            header h1 { font-size: 1.3rem; }
        }

        /* Onboarding overlay */
        .onboarding-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .onboarding-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem 1.5rem;
            max-width: 420px;
            width: 100%;
            text-align: center;
        }
        .onboarding-card h2 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }
        .onboarding-card p {
            color: var(--text-dim);
            margin-bottom: 1.2rem;
            line-height: 1.5;
        }
        .onboarding-suggestions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.2rem;
        }
        .onboarding-suggestion {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.7rem 1rem;
            color: var(--text);
            cursor: pointer;
            font-size: 0.95rem;
            transition: border-color 0.2s, background 0.2s;
            text-align: left;
        }
        .onboarding-suggestion:hover {
            border-color: var(--accent);
            background: var(--accent-glow);
        }
        .onboarding-suggestion .lang-hint {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 0.2rem;
        }
        .onboarding-skip {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.85rem;
            text-decoration: underline;
        }
        .onboarding-skip:hover { color: var(--text); }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Onboarding overlay for first-time users -->
    <div id="onboarding-overlay" class="onboarding-overlay hidden">
        <div class="onboarding-card">
            <h2>‚ö° Welcome to Sentsei</h2>
            <p>Type any sentence and learn how to say it in another language ‚Äî with pronunciation, grammar notes, and word-by-word breakdown.</p>
            <p style="color: var(--text); font-weight: 500;">Try one of these to start:</p>
            <div class="onboarding-suggestions">
                <button class="onboarding-suggestion" data-sentence="I want to eat ramen for dinner" data-lang="ja">
                    "I want to eat ramen for dinner"
                    <div class="lang-hint">‚Üí üáØüáµ Japanese</div>
                </button>
                <button class="onboarding-suggestion" data-sentence="Where is the nearest subway station?" data-lang="ko">
                    "Where is the nearest subway station?"
                    <div class="lang-hint">‚Üí üá∞üá∑ Korean</div>
                </button>
                <button class="onboarding-suggestion" data-sentence="This coffee tastes amazing" data-lang="zh">
                    "This coffee tastes amazing"
                    <div class="lang-hint">‚Üí üáπüáº Chinese</div>
                </button>
            </div>
            <button class="onboarding-skip" id="onboarding-skip">Skip ‚Äî I'll type my own</button>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Sentsei</h1>
            <p>Say what's on your mind. Learn it in any language.</p>
        </header>

        <div class="input-area">
            <div class="language-select">
                <label>I'm typing in</label>
                <div id="input-lang-pills" class="lang-pills">
                    <button type="button" class="lang-pill active" data-lang="auto">üîç Auto-detect</button>
                    <button type="button" class="lang-pill" data-lang="en">üá∫üá∏ English</button>
                    <button type="button" class="lang-pill" data-lang="zh">üáπüáº ‰∏≠Êñá</button>
                </div>
            </div>
            <div class="language-select">
                <label>Translate to</label>
                <div id="lang-pills" class="lang-pills"></div>
                <select id="lang" style="display:none"></select>
            </div>
            <div class="toggle-row">
                <label>Speaking as</label>
                <div class="toggle-pills" id="gender-pills">
                    <button type="button" class="toggle-pill" data-value="female">‚ôÄ Female</button>
                    <button type="button" class="toggle-pill" data-value="male">‚ôÇ Male</button>
                    <button type="button" class="toggle-pill active" data-value="neutral">‚ö™ Neutral</button>
                </div>
            </div>
            <div class="toggle-row">
                <label>Formality</label>
                <div class="toggle-pills" id="formality-pills">
                    <button type="button" class="toggle-pill" data-value="casual">Casual</button>
                    <button type="button" class="toggle-pill active" data-value="polite">Polite</button>
                    <button type="button" class="toggle-pill" data-value="formal">Formal</button>
                </div>
            </div>
            <div class="sentence-input">
                <textarea id="sentence" placeholder="Type a sentence or paragraph in English or Chinese..." rows="1"></textarea>
                <div class="sentence-input-actions">
                    <button id="learn-btn" onclick="learn()">Learn</button>
                    <button id="surprise-btn" class="surprise-btn" onclick="surpriseMe()">üé≤ Surprise me</button>
                    <button id="compare-btn" class="surprise-btn" onclick="compareSentence()">üåç Compare</button>
                </div>
            </div>
            <div class="input-hint">Press Enter to learn</div>
            <div id="sentence-history-wrap" class="sentence-history-wrap hidden">
                <div class="sentence-history-title">Recent Sentences</div>
                <div id="sentence-history" class="sentence-history"></div>
            </div>
        </div>

        <div id="quiz-area" class="quiz-area hidden">
            <div class="quiz-header">
                <div>
                    <div class="quiz-title">Reverse Mode Quiz</div>
                    <div id="quiz-meta" class="quiz-meta"></div>
                </div>
                <div id="quiz-score" class="quiz-score">0/0</div>
            </div>
            <div class="quiz-card">
                <div class="quiz-label">Translate Into English or Chinese</div>
                <div id="quiz-sentence" class="quiz-sentence">Loading...</div>
                <div id="quiz-pronunciation" class="quiz-pronunciation"></div>
                <div id="quiz-source" class="quiz-source"></div>
                <div id="quiz-hint" class="quiz-hint"></div>
                <div class="quiz-answer-row">
                    <input id="quiz-answer" class="quiz-answer-input" type="text" placeholder="Type your translation..." autocomplete="off">
                    <button id="quiz-check-btn" class="quiz-check-btn" type="button">Check</button>
                </div>
                <div id="quiz-result" class="quiz-result hidden"></div>
                <div class="quiz-actions">
                    <button id="quiz-next-btn" class="quiz-next-btn" type="button">Next Question</button>
                    <button id="quiz-exit-btn" class="quiz-exit-btn" type="button">Exit Quiz</button>
                </div>
            </div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p id="loading-message" class="loading-message">Breaking it down...</p>
            <p id="loading-tip" class="loading-tip"></p>
            <p id="loading-elapsed" class="loading-elapsed"></p>
            <button id="loading-cancel" class="loading-cancel" style="display:none">Cancel</button>
        </div>
        <div id="error-banner" class="error-banner" style="display:none">
            <p id="error-message">Something went wrong.</p>
            <button id="retry-btn">Try again</button>
        </div>

        <div id="compare-results" class="hidden"></div>
        <div id="results"></div>
    </div>

    <div class="header-left-actions">
        <button id="stories-toggle" class="stories-toggle-btn" aria-label="Toggle stories">
            üìñ Stories <span id="stories-badge" class="badge">0</span>
        </button>
        <button id="quiz-toggle" class="quiz-toggle-btn" aria-label="Toggle quiz mode">üß† Quiz</button>
    </div>

    <!-- Stories Panel -->
    <div id="stories-overlay" class="stories-overlay"></div>
    <div id="stories-panel" class="stories-panel">
        <div class="stories-panel-header">
            <h3>Stories</h3>
            <button id="stories-panel-close" class="history-panel-close" aria-label="Close stories">‚úï</button>
        </div>
        <div class="stories-panel-content">
            <div id="stories-browser" class="stories-browser">
                <div id="stories-filter" class="stories-filter"></div>
                <div id="stories-list" class="stories-list"></div>
            </div>
            <div id="story-reader" class="story-reader hidden">
                <div class="story-reader-head">
                    <button id="story-back-btn" class="story-back-btn" type="button">‚Üê All stories</button>
                    <div id="story-progress" class="story-progress">1/1</div>
                </div>
                <div id="story-title" class="story-title"></div>
                <div id="story-source" class="story-source"></div>
                <div id="story-sentence" class="story-sentence"></div>
                <div class="story-nav">
                    <button id="story-prev-btn" type="button">‚Üê Prev</button>
                    <button id="story-next-btn" type="button">Next ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <button id="history-toggle" class="history-toggle-btn hidden" aria-label="Toggle history">
        üìú <span id="history-badge" class="badge">0</span>
    </button>
    <div id="history-overlay" class="history-overlay"></div>
    <div id="history-panel" class="history-panel">
        <div class="history-panel-header">
            <h3>History</h3>
            <button id="history-panel-close" class="history-panel-close" aria-label="Close history">‚úï</button>
        </div>
        <div id="history-panel-list" class="history-panel-list">
            <div class="history-panel-empty">No sentences yet. Start learning!</div>
        </div>
        <div class="history-panel-clear">
            <div class="history-panel-export">
                <button id="history-export-anki-btn" type="button" class="toggle-pill">üì• Anki</button>
                <button id="history-copy-all-btn" type="button" class="toggle-pill">üìã Copy All</button>
            </div>
            <button id="history-clear-btn">Clear All History</button>
        </div>
    </div>

    <div id="password-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="password-modal-title">
        <div class="modal">
            <h2 id="password-modal-title">Unlock Sentsei</h2>
            <p>Enter the app password to start learning.</p>
            <form id="password-form" class="password-form">
                <input id="password-input" type="password" placeholder="Password" autocomplete="current-password" required>
                <button type="submit">Unlock</button>
            </form>
            <div id="password-error" class="password-error hidden">Incorrect password. Try again.</div>
        </div>
    </div>

    <script>
        const langSelect = document.getElementById('lang');
        const langPillsEl = document.getElementById('lang-pills');
        const LANG_FLAGS = {
            ko: 'üá∞üá∑', ja: 'üáØüáµ', zh: 'üáπüáº', en: 'üá∫üá∏',
            he: 'üáÆüá±', el: 'üá¨üá∑', it: 'üáÆüáπ', es: 'üá™üá∏',
            fr: 'üá´üá∑', de: 'üá©üá™', pt: 'üáßüá∑', ar: 'üá∏üá¶',
            th: 'üáπüá≠', vi: 'üáªüá≥', hi: 'üáÆüá≥', ru: 'üá∑üá∫'
        };
        const sentenceInput = document.getElementById('sentence');
        const learnBtn = document.getElementById('learn-btn');
        const surpriseBtn = document.getElementById('surprise-btn');
        const compareBtn = document.getElementById('compare-btn');
        const loadingEl = document.getElementById('loading');
        const loadingTipEl = document.getElementById('loading-tip');
        const compareResultsEl = document.getElementById('compare-results');
        const resultsEl = document.getElementById('results');
        const sentenceHistoryWrapEl = document.getElementById('sentence-history-wrap');
        const sentenceHistoryEl = document.getElementById('sentence-history');
        const passwordModalEl = document.getElementById('password-modal');
        const passwordFormEl = document.getElementById('password-form');
        const passwordInputEl = document.getElementById('password-input');
        const passwordErrorEl = document.getElementById('password-error');
        const genderPillsEl = document.getElementById('gender-pills');
        const formalityPillsEl = document.getElementById('formality-pills');
        const GENDER_KEY = 'sentsei_speaker_gender';
        const FORMALITY_KEY = 'sentsei_speaker_formality';
        let selectedGender = localStorage.getItem(GENDER_KEY) || 'neutral';
        let selectedFormality = localStorage.getItem(FORMALITY_KEY) || 'polite';

        function initToggle(container, current, storageKey, setter) {
            container.querySelectorAll('.toggle-pill').forEach(p => {
                p.classList.toggle('active', p.dataset.value === current);
                p.addEventListener('click', () => {
                    container.querySelectorAll('.toggle-pill').forEach(q => q.classList.remove('active'));
                    p.classList.add('active');
                    localStorage.setItem(storageKey, p.dataset.value);
                    setter(p.dataset.value);
                });
            });
        }

        initToggle(genderPillsEl, selectedGender, GENDER_KEY, v => selectedGender = v);
        initToggle(formalityPillsEl, selectedFormality, FORMALITY_KEY, v => selectedFormality = v);

        // Input language selector
        const INPUT_LANG_KEY = 'sentsei_input_lang';
        let selectedInputLang = localStorage.getItem(INPUT_LANG_KEY) || 'auto';
        const inputLangPillsEl = document.getElementById('input-lang-pills');
        inputLangPillsEl.querySelectorAll('.lang-pill').forEach(p => {
            p.classList.toggle('active', p.dataset.lang === selectedInputLang);
            p.addEventListener('click', () => {
                inputLangPillsEl.querySelectorAll('.lang-pill').forEach(q => q.classList.remove('active'));
                p.classList.add('active');
                selectedInputLang = p.dataset.lang;
                localStorage.setItem(INPUT_LANG_KEY, selectedInputLang);
            });
        });

        const APP_PASSWORD = 'sentsei2026';
        const PASSWORD_STORAGE_KEY = 'sentsei_app_password';
        const SENTENCE_HISTORY_KEY = 'sentsei_sentence_history';
        const RICH_HISTORY_KEY = 'sentsei_rich_history';
        const STORY_PROGRESS_KEY = 'sentsei_story_progress';
        const QUIZ_SCORE_KEY = 'sentsei_quiz_score';
        const HISTORY_LIMIT = 50;
        const storiesToggleBtn = document.getElementById('stories-toggle');
        const storiesBadgeEl = document.getElementById('stories-badge');
        const storiesPanelEl = document.getElementById('stories-panel');
        const storiesOverlayEl = document.getElementById('stories-overlay');
        const storiesPanelCloseBtn = document.getElementById('stories-panel-close');
        const storiesFilterEl = document.getElementById('stories-filter');
        const storiesListEl = document.getElementById('stories-list');
        const storiesBrowserEl = document.getElementById('stories-browser');
        const storyReaderEl = document.getElementById('story-reader');
        const storyBackBtn = document.getElementById('story-back-btn');
        const storyTitleEl = document.getElementById('story-title');
        const storySourceEl = document.getElementById('story-source');
        const storySentenceEl = document.getElementById('story-sentence');
        const storyProgressEl = document.getElementById('story-progress');
        const storyPrevBtn = document.getElementById('story-prev-btn');
        const storyNextBtn = document.getElementById('story-next-btn');
        const historyToggleBtn = document.getElementById('history-toggle');
        const historyBadgeEl = document.getElementById('history-badge');
        const historyPanelEl = document.getElementById('history-panel');
        const historyPanelListEl = document.getElementById('history-panel-list');
        const historyOverlayEl = document.getElementById('history-overlay');
        const historyClearBtn = document.getElementById('history-clear-btn');
        const historyExportAnkiBtn = document.getElementById('history-export-anki-btn');
        const historyCopyAllBtn = document.getElementById('history-copy-all-btn');
        const historyPanelCloseBtn = document.getElementById('history-panel-close');
        const quizToggleBtn = document.getElementById('quiz-toggle');
        const quizAreaEl = document.getElementById('quiz-area');
        const quizMetaEl = document.getElementById('quiz-meta');
        const quizScoreEl = document.getElementById('quiz-score');
        const quizSentenceEl = document.getElementById('quiz-sentence');
        const quizPronunciationEl = document.getElementById('quiz-pronunciation');
        const quizSourceEl = document.getElementById('quiz-source');
        const quizHintEl = document.getElementById('quiz-hint');
        const quizAnswerInputEl = document.getElementById('quiz-answer');
        const quizCheckBtn = document.getElementById('quiz-check-btn');
        const quizResultEl = document.getElementById('quiz-result');
        const quizNextBtn = document.getElementById('quiz-next-btn');
        const quizExitBtn = document.getElementById('quiz-exit-btn');
        const LANGUAGE_TIPS = {
            ko: [
                'Korean changes formality based on who you are talking to.',
                'Sentence endings in Korean carry a lot of the tone.',
                'Particles like eun/neun and i/ga show topic and subject.'
            ],
            ja: [
                'In Japanese, context often lets you omit the subject.',
                'Sentence endings like ne and yo add nuance to intent.',
                'Polite and casual Japanese can sound very different.'
            ],
            zh: [
                'Chinese word order is often similar to English, but measure words matter.',
                'Aspect particles such as le and guo change meaning quickly.',
                'Tone changes can completely change a word.'
            ],
            es: [
                'Spanish verb endings encode person, number, and tense.',
                'Gender agreement applies to many nouns and adjectives.',
                'Formal and informal "you" forms change conjugation.'
            ],
            fr: [
                'French articles are essential and must match noun gender.',
                'Liaison can change how words connect in speech.',
                'Reflexive verbs are very common in everyday French.'
            ],
            de: [
                'German noun gender affects articles and adjective endings.',
                'Verb position changes in subordinate clauses.',
                'Cases signal each word role in the sentence.'
            ],
            default: [
                'Try short, natural phrases first, then expand complexity.',
                'Notice patterns in sentence endings to learn faster.',
                'Repetition with tiny changes helps grammar stick.'
            ]
        };
        let appPassword = localStorage.getItem(PASSWORD_STORAGE_KEY) || '';
        let sentenceHistory = loadSentenceHistory();
        let richHistory = loadRichHistory();
        let languagesLoaded = false;
        let stories = [];
        let storyPanelOpen = false;
        let storyProgress = loadStoryProgress();
        let activeStory = null;
        let activeStoryIndex = 0;
        let storyCache = {};
        let historyPanelOpen = false;
        let quizMode = false;
        let currentQuiz = null;
        let quizStats = loadQuizStats();

        const QUIZ_SCORE_LABELS = {
            perfect: '‚úÖ Perfect',
            good: 'üëç Good',
            partial: 'ü§î Partial',
            wrong: '‚ùå Wrong'
        };

        function loadRichHistory() {
            try {
                const raw = localStorage.getItem(RICH_HISTORY_KEY) || '[]';
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) return [];
                return parsed.slice(0, HISTORY_LIMIT);
            } catch { return []; }
        }

        function saveRichHistory() {
            localStorage.setItem(RICH_HISTORY_KEY, JSON.stringify(richHistory));
        }

        function loadStoryProgress() {
            try {
                const raw = localStorage.getItem(STORY_PROGRESS_KEY) || '{}';
                const parsed = JSON.parse(raw);
                if (!parsed || typeof parsed !== 'object') return {};
                return parsed;
            } catch {
                return {};
            }
        }

        function saveStoryProgress() {
            localStorage.setItem(STORY_PROGRESS_KEY, JSON.stringify(storyProgress));
        }

        function loadQuizStats() {
            try {
                const raw = sessionStorage.getItem(QUIZ_SCORE_KEY) || '{}';
                const parsed = JSON.parse(raw);
                const correct = Number(parsed.correct) || 0;
                const total = Number(parsed.total) || 0;
                return {
                    correct: Math.max(0, correct),
                    total: Math.max(0, total)
                };
            } catch {
                return { correct: 0, total: 0 };
            }
        }

        function saveQuizStats() {
            sessionStorage.setItem(QUIZ_SCORE_KEY, JSON.stringify(quizStats));
        }

        function renderQuizScore() {
            quizScoreEl.textContent = `${quizStats.correct}/${quizStats.total}`;
        }

        function renderQuizMeta() {
            const selectedLang = langSelect.value;
            const flag = LANG_FLAGS[selectedLang] || 'üåê';
            const langName = langSelect.options[langSelect.selectedIndex]?.textContent || selectedLang || '';
            quizMetaEl.textContent = `${flag} ${langName} ‚Ä¢ Meaning match`;
        }

        function clearQuizResult() {
            quizResultEl.className = 'quiz-result hidden';
            quizResultEl.innerHTML = '';
        }

        function showQuizResult(result) {
            const score = ['perfect', 'good', 'partial', 'wrong'].includes(result.score) ? result.score : 'wrong';
            const label = QUIZ_SCORE_LABELS[score];
            const answer = result.correct_answer || 'N/A';
            const feedback = result.feedback || '';
            quizResultEl.innerHTML = `
                <div class="quiz-result-head">${label}</div>
                <div class="quiz-result-answer"><strong>Correct answer:</strong> ${answer}</div>
                <div class="quiz-result-feedback">${feedback}</div>
            `;
            quizResultEl.className = `quiz-result ${score}`;
            // Restart reveal animation each time new feedback appears.
            void quizResultEl.offsetWidth;
            quizResultEl.classList.add('show');
        }

        async function loadQuizQuestion() {
            if (!ensurePassword()) return;
            if (!languagesLoaded) await loadLanguages();

            renderQuizMeta();
            clearQuizResult();
            currentQuiz = null;
            quizAnswerInputEl.value = '';

            quizSentenceEl.textContent = 'Loading question...';
            quizPronunciationEl.textContent = '';
            quizSourceEl.textContent = '';
            quizHintEl.textContent = '';
            quizCheckBtn.disabled = true;
            quizNextBtn.disabled = true;

            try {
                const params = new URLSearchParams({
                    lang: langSelect.value,
                    gender: selectedGender,
                    formality: selectedFormality
                });
                const resp = await fetch(`/api/quiz?${params.toString()}`, {
                    headers: { 'X-App-Password': appPassword }
                });

                if (resp.status === 401) {
                    localStorage.removeItem(PASSWORD_STORAGE_KEY);
                    appPassword = '';
                    openPasswordModal('Session expired. Enter password again.');
                    return;
                }
                if (!resp.ok) throw new Error('API error');

                const data = await resp.json();
                currentQuiz = data;
                quizSentenceEl.textContent = data.sentence || '';
                quizPronunciationEl.textContent = data.pronunciation ? `Pronunciation: ${data.pronunciation}` : 'Pronunciation: ‚Äî';
                quizSourceEl.textContent = data.source ? `Source: ${data.source}` : 'Source: Curated sentence';
                quizHintEl.textContent = data.hint ? `Hint: starts with "${data.hint}"` : '';
                quizCheckBtn.disabled = false;
                quizNextBtn.disabled = false;
                quizAnswerInputEl.focus();
            } catch (err) {
                console.error(err);
                quizSentenceEl.textContent = 'Could not load a question right now.';
                quizSourceEl.textContent = 'Try again.';
                quizHintEl.textContent = '';
                quizCheckBtn.disabled = true;
                quizNextBtn.disabled = false;
            }
        }

        async function checkQuizAnswer() {
            if (!ensurePassword()) return;
            if (!currentQuiz) return;

            const answer = quizAnswerInputEl.value.trim();
            if (!answer) {
                quizAnswerInputEl.focus();
                return;
            }

            const originalLabel = quizCheckBtn.textContent;
            quizCheckBtn.disabled = true;
            quizCheckBtn.textContent = 'Checking...';

            try {
                const resp = await fetch('/api/quiz-check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-App-Password': appPassword
                    },
                    body: JSON.stringify({
                        quiz_id: currentQuiz.quiz_id,
                        answer,
                        target_language: currentQuiz.language
                    })
                });

                if (resp.status === 401) {
                    localStorage.removeItem(PASSWORD_STORAGE_KEY);
                    appPassword = '';
                    openPasswordModal('Session expired. Enter password again.');
                    return;
                }
                if (!resp.ok) throw new Error('API error');

                const data = await resp.json();
                quizStats.total += 1;
                if (data.correct) quizStats.correct += 1;
                saveQuizStats();
                renderQuizScore();
                showQuizResult(data);
            } catch (err) {
                console.error(err);
                clearQuizResult();
                quizResultEl.innerHTML = '<div class="quiz-result-feedback">Could not check this answer. Try again.</div>';
                quizResultEl.className = 'quiz-result wrong show';
            } finally {
                quizCheckBtn.textContent = originalLabel;
                quizCheckBtn.disabled = false;
            }
        }

        async function enterQuizMode() {
            if (!ensurePassword()) return;
            quizMode = true;
            document.body.classList.add('quiz-mode');
            quizAreaEl.classList.remove('hidden');
            quizToggleBtn.classList.add('active');
            renderQuizScore();
            await loadQuizQuestion();
        }

        function exitQuizMode() {
            quizMode = false;
            currentQuiz = null;
            document.body.classList.remove('quiz-mode');
            quizAreaEl.classList.add('hidden');
            quizToggleBtn.classList.remove('active');
            clearQuizResult();
        }

        async function toggleQuizMode() {
            if (quizMode) {
                exitQuizMode();
                return;
            }
            await enterQuizMode();
        }

        function updateStoriesBadge() {
            if (!storiesBadgeEl) return;
            const selectedLang = langSelect.value;
            const count = selectedLang ? stories.filter(s => s.language === selectedLang).length : stories.length;
            storiesBadgeEl.textContent = count;
        }

        function getStoryProgress(storyId, sentenceCount) {
            const raw = Number(storyProgress[storyId] || 0);
            if (!Number.isFinite(raw) || raw < 0) return 0;
            if (!sentenceCount || sentenceCount < 1) return 0;
            return Math.min(raw, sentenceCount - 1);
        }

        function setStoryProgress(storyId, index) {
            if (!storyId || !Number.isFinite(index) || index < 0) return;
            storyProgress[storyId] = index;
            saveStoryProgress();
        }

        function addToRichHistory(sentence, translation, targetLang, pronunciation) {
            const entry = {
                sentence,
                translation,
                lang: targetLang,
                pronunciation: pronunciation || '',
                ts: Date.now()
            };
            // Remove duplicate
            richHistory = richHistory.filter(e => !(e.sentence === sentence && e.lang === targetLang));
            richHistory.unshift(entry);
            richHistory = richHistory.slice(0, HISTORY_LIMIT);
            saveRichHistory();
            renderHistoryPanel();
            updateHistoryBadge();
        }

        function getLanguageNamesMap() {
            const langNames = {};
            langSelect.querySelectorAll('option').forEach(o => { langNames[o.value] = o.textContent; });
            return langNames;
        }

        function buildHistoryCopyText() {
            const langNames = getLanguageNamesMap();
            return richHistory.map((entry, idx) => {
                const langCode = entry.lang || '';
                const langName = langNames[langCode] || langCode || 'Unknown';
                const langLine = langCode ? `${langName} (${langCode})` : langName;
                const timeLine = entry.ts ? new Date(entry.ts).toLocaleString() : '';
                const lines = [
                    `${idx + 1}. ${entry.translation || ''}`,
                    `Original: ${entry.sentence || ''}`,
                    `Pronunciation: ${entry.pronunciation || '‚Äî'}`,
                    `Language: ${langLine}`
                ];
                if (timeLine) lines.push(`Saved: ${timeLine}`);
                return lines.join('\n');
            }).join('\n\n');
        }

        function buildHistoryAnkiPayload() {
            return richHistory.map(entry => ({
                sentence: entry.sentence || '',
                translation: entry.translation || '',
                pronunciation: entry.pronunciation || '',
                target: entry.lang || '',
                timestamp: entry.ts ? new Date(entry.ts).toISOString() : ''
            }));
        }

        async function exportHistoryAsAnki() {
            if (!ensurePassword()) return;
            if (richHistory.length === 0) {
                alert('No history to export yet.');
                return;
            }

            const originalLabel = historyExportAnkiBtn.textContent;
            historyExportAnkiBtn.disabled = true;
            historyExportAnkiBtn.textContent = 'Exporting...';

            try {
                const resp = await fetch('/api/export-anki', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-App-Password': appPassword
                    },
                    body: JSON.stringify(buildHistoryAnkiPayload())
                });

                if (resp.status === 401) {
                    localStorage.removeItem(PASSWORD_STORAGE_KEY);
                    appPassword = '';
                    openPasswordModal('Session expired. Enter password again.');
                    return;
                }
                if (!resp.ok) throw new Error('API error');

                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'sentsei-flashcards.txt';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                historyExportAnkiBtn.textContent = 'Done';
            } catch (err) {
                console.error(err);
                alert('Could not export Anki file.');
                historyExportAnkiBtn.textContent = 'Failed';
            } finally {
                setTimeout(() => {
                    historyExportAnkiBtn.textContent = originalLabel;
                    historyExportAnkiBtn.disabled = false;
                }, 1000);
            }
        }

        async function copyAllHistoryToClipboard() {
            if (richHistory.length === 0) {
                alert('No history to copy yet.');
                return;
            }

            const originalLabel = historyCopyAllBtn.textContent;
            historyCopyAllBtn.disabled = true;
            try {
                const copied = await copyTextToClipboard(buildHistoryCopyText());
                historyCopyAllBtn.textContent = copied ? 'Copied' : 'Failed';
            } catch (err) {
                console.error(err);
                historyCopyAllBtn.textContent = 'Failed';
            } finally {
                setTimeout(() => {
                    historyCopyAllBtn.textContent = originalLabel;
                    historyCopyAllBtn.disabled = false;
                }, 1000);
            }
        }

        function toggleHistoryPanel() {
            historyPanelOpen = !historyPanelOpen;
            historyPanelEl.classList.toggle('open', historyPanelOpen);
            historyOverlayEl.classList.toggle('open', historyPanelOpen);
        }

        function closeHistoryPanel() {
            historyPanelOpen = false;
            historyPanelEl.classList.remove('open');
            historyOverlayEl.classList.remove('open');
        }

        function updateHistoryBadge() {
            const count = richHistory.length;
            historyBadgeEl.textContent = count;
            historyToggleBtn.classList.toggle('hidden', count === 0);
        }

        function renderHistoryPanel() {
            if (richHistory.length === 0) {
                historyPanelListEl.innerHTML = '<div class="history-panel-empty">No sentences yet. Start learning!</div>';
                return;
            }
            const langNames = getLanguageNamesMap();

            historyPanelListEl.innerHTML = richHistory.map((entry, idx) => {
                const flag = LANG_FLAGS[entry.lang] || 'üåê';
                const langName = langNames[entry.lang] || entry.lang;
                const time = new Date(entry.ts);
                const timeStr = time.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' + time.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                return `<div class="history-panel-item" data-idx="${idx}">
                    <div class="hp-translation">${entry.translation}</div>
                    <div class="hp-sentence">${entry.sentence}</div>
                    <div class="hp-meta"><span class="hp-lang">${flag} ${langName}</span><span>${timeStr}</span></div>
                </div>`;
            }).join('');

            historyPanelListEl.querySelectorAll('.history-panel-item').forEach(item => {
                item.addEventListener('click', () => {
                    const idx = parseInt(item.dataset.idx);
                    const entry = richHistory[idx];
                    if (entry) {
                        sentenceInput.value = entry.sentence;
                        sentenceInput.style.height = 'auto';
                        sentenceInput.style.height = sentenceInput.scrollHeight + 'px';
                        if (entry.lang) selectLangPill(entry.lang);
                        closeHistoryPanel();
                        sentenceInput.focus();
                    }
                });
            });
        }

        historyToggleBtn.addEventListener('click', toggleHistoryPanel);
        historyOverlayEl.addEventListener('click', closeHistoryPanel);
        historyPanelCloseBtn.addEventListener('click', closeHistoryPanel);
        historyExportAnkiBtn.addEventListener('click', exportHistoryAsAnki);
        historyCopyAllBtn.addEventListener('click', copyAllHistoryToClipboard);
        historyClearBtn.addEventListener('click', () => {
            if (confirm('Clear all history?')) {
                richHistory = [];
                sentenceHistory = [];
                saveRichHistory();
                localStorage.setItem(SENTENCE_HISTORY_KEY, '[]');
                renderHistoryPanel();
                renderSentenceHistory();
                updateHistoryBadge();
            }
        });

        updateHistoryBadge();

        function lockApp() {
            sentenceInput.disabled = true;
            langSelect.disabled = true;
            learnBtn.disabled = true;
            compareBtn.disabled = true;
        }

        function unlockApp() {
            sentenceInput.disabled = false;
            langSelect.disabled = false;
            learnBtn.disabled = false;
            compareBtn.disabled = false;
        }

        function showPasswordError(message) {
            passwordErrorEl.textContent = message;
            passwordErrorEl.classList.remove('hidden');
        }

        function hidePasswordError() {
            passwordErrorEl.classList.add('hidden');
        }

        function openPasswordModal(message = '') {
            lockApp();
            passwordModalEl.classList.remove('hidden');
            document.body.classList.add('modal-open');
            passwordInputEl.value = '';
            if (message) {
                showPasswordError(message);
            } else {
                hidePasswordError();
            }
            requestAnimationFrame(() => passwordInputEl.focus());
        }

        function closePasswordModal() {
            passwordModalEl.classList.add('hidden');
            document.body.classList.remove('modal-open');
            hidePasswordError();
        }

        function ensurePassword() {
            if (appPassword === APP_PASSWORD) return true;
            openPasswordModal();
            return false;
        }

        function loadSentenceHistory() {
            try {
                const raw = localStorage.getItem(SENTENCE_HISTORY_KEY) || '[]';
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) return [];
                return parsed
                    .filter(item => typeof item === 'string' && item.trim())
                    .slice(0, HISTORY_LIMIT);
            } catch {
                return [];
            }
        }

        function renderSentenceHistory() {
            sentenceHistoryEl.innerHTML = '';
            if (sentenceHistory.length === 0) {
                sentenceHistoryWrapEl.classList.add('hidden');
                return;
            }

            sentenceHistoryWrapEl.classList.remove('hidden');
            sentenceHistory.forEach((sentence) => {
                const chip = document.createElement('button');
                chip.type = 'button';
                chip.className = 'history-chip';
                chip.textContent = sentence;
                chip.title = sentence;
                chip.addEventListener('click', () => {
                    sentenceInput.value = sentence;
                    sentenceInput.style.height = 'auto';
                    sentenceInput.style.height = sentenceInput.scrollHeight + 'px';
                    sentenceInput.focus();
                });
                sentenceHistoryEl.appendChild(chip);
            });
        }

        function saveSentenceToHistory(sentence) {
            const cleanSentence = sentence.trim();
            if (!cleanSentence) return;
            sentenceHistory = [cleanSentence, ...sentenceHistory.filter(item => item !== cleanSentence)].slice(0, HISTORY_LIMIT);
            localStorage.setItem(SENTENCE_HISTORY_KEY, JSON.stringify(sentenceHistory));
            renderSentenceHistory();
        }

        function setRandomLoadingTip() {
            const selectedLang = langSelect.value;
            const langName = langSelect.options[langSelect.selectedIndex]?.textContent || 'this language';
            const tips = LANGUAGE_TIPS[selectedLang] || LANGUAGE_TIPS.default;
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            loadingTipEl.textContent = `${langName} tip: ${randomTip}`;
        }

        // === TTS / Speech ===
        const LANG_SPEECH_MAP = {
            ko: 'ko-KR', ja: 'ja-JP', zh: 'zh-TW', en: 'en-US',
            he: 'he-IL', el: 'el-GR', it: 'it-IT', es: 'es-ES',
            fr: 'fr-FR', de: 'de-DE', pt: 'pt-BR', ar: 'ar-SA',
            th: 'th-TH', vi: 'vi-VN', hi: 'hi-IN', ru: 'ru-RU'
        };

        function speakTranslation(text, langCode, btn) {
            if (!window.speechSynthesis) return;
            // Stop any current speech
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = LANG_SPEECH_MAP[langCode] || langCode;
            utterance.rate = 0.85;
            // Try to find a matching voice
            const voices = speechSynthesis.getVoices();
            const match = voices.find(v => v.lang === utterance.lang) ||
                          voices.find(v => v.lang.startsWith(langCode));
            if (match) utterance.voice = match;
            if (btn) {
                btn.classList.add('speaking');
                const label = btn.querySelector('.speak-label');
                if (label) label.textContent = '‚ñ∂ Playing';
                utterance.onend = () => {
                    btn.classList.remove('speaking');
                    if (label) label.textContent = 'Listen';
                };
                utterance.onerror = () => {
                    btn.classList.remove('speaking');
                    if (label) label.textContent = 'Listen';
                };
            }
            speechSynthesis.speak(utterance);
        }

        // Pre-load voices
        if (window.speechSynthesis) {
            speechSynthesis.getVoices();
            speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
        }

        async function copyTextToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                return true;
            }

            const fallbackArea = document.createElement('textarea');
            fallbackArea.value = text;
            fallbackArea.setAttribute('readonly', '');
            fallbackArea.style.position = 'fixed';
            fallbackArea.style.opacity = '0';
            document.body.appendChild(fallbackArea);
            fallbackArea.select();

            let copied = false;
            try {
                copied = document.execCommand('copy');
            } catch {
                copied = false;
            }

            document.body.removeChild(fallbackArea);
            return copied;
        }

        // --- Onboarding ---
        const ONBOARDED_KEY = 'sentsei_onboarded';
        const onboardingOverlay = document.getElementById('onboarding-overlay');

        function showOnboarding() {
            if (localStorage.getItem(ONBOARDED_KEY)) return;
            if (richHistory.length > 0 || sentenceHistory.length > 0) {
                localStorage.setItem(ONBOARDED_KEY, '1');
                return;
            }
            onboardingOverlay.classList.remove('hidden');
        }

        function dismissOnboarding() {
            onboardingOverlay.classList.add('hidden');
            localStorage.setItem(ONBOARDED_KEY, '1');
        }

        document.querySelectorAll('.onboarding-suggestion').forEach(btn => {
            btn.addEventListener('click', () => {
                const sentence = btn.dataset.sentence;
                const lang = btn.dataset.lang;
                dismissOnboarding();
                // Wait for languages to load, then select + fill + submit
                const tryFill = () => {
                    if (languagesLoaded) {
                        if (lang) selectLangPill(lang);
                        sentenceInput.value = sentence;
                        sentenceInput.style.height = 'auto';
                        sentenceInput.style.height = sentenceInput.scrollHeight + 'px';
                        learn();
                    } else {
                        setTimeout(tryFill, 200);
                    }
                };
                tryFill();
            });
        });

        document.getElementById('onboarding-skip').addEventListener('click', () => {
            dismissOnboarding();
            sentenceInput.focus();
        });

        // Show onboarding after password check passes
        if (appPassword === APP_PASSWORD) {
            showOnboarding();
        }
        // Also hook into password submit success
        const _origCloseModal = closePasswordModal;
        closePasswordModal = function() {
            _origCloseModal();
            setTimeout(showOnboarding, 300);
        };

        // Auto-resize textarea
        sentenceInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        // IME composition tracking (Ê≥®Èü≥, etc.)
        let isComposing = false;
        sentenceInput.addEventListener('compositionstart', () => { isComposing = true; });
        sentenceInput.addEventListener('compositionend', () => { isComposing = false; });

        // Enter to submit (skip during IME composition)
        sentenceInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !isComposing) {
                e.preventDefault();
                learn();
            }
        });

        function selectLangPill(code) {
            langSelect.value = code;
            langPillsEl.querySelectorAll('.lang-pill').forEach(p => {
                p.classList.toggle('active', p.dataset.lang === code);
            });
        }

        async function loadLanguages() {
            if (languagesLoaded) return;
            const langs = await fetch('/api/languages').then(r => r.json());
            langPillsEl.innerHTML = '';
            for (const [code, name] of Object.entries(langs)) {
                // Hidden select for compatibility
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = name;
                langSelect.appendChild(opt);
                // Pill button
                const pill = document.createElement('button');
                pill.type = 'button';
                pill.className = 'lang-pill';
                pill.dataset.lang = code;
                const flag = LANG_FLAGS[code] || 'üåê';
                pill.innerHTML = `<span class="flag">${flag}</span>${name}`;
                pill.addEventListener('click', () => selectLangPill(code));
                langPillsEl.appendChild(pill);
            }
            // Default to Korean
            const defaultLang = Object.prototype.hasOwnProperty.call(langs, 'ko') ? 'ko' : Object.keys(langs)[0];
            if (defaultLang) selectLangPill(defaultLang);
            languagesLoaded = true;
            renderHistoryPanel();
        }

        passwordFormEl.addEventListener('submit', async function(e) {
            e.preventDefault();
            const entered = passwordInputEl.value.trim();
            if (entered !== APP_PASSWORD) {
                showPasswordError('Incorrect password. Try again.');
                passwordInputEl.select();
                return;
            }

            appPassword = APP_PASSWORD;
            localStorage.setItem(PASSWORD_STORAGE_KEY, APP_PASSWORD);
            closePasswordModal();
            unlockApp();

            try {
                await loadLanguages();
            } catch (err) {
                console.error(err);
                alert('Failed to load languages.');
            }
        });

        renderSentenceHistory();
        if (ensurePassword()) {
            unlockApp();
            loadLanguages().catch(err => {
                console.error(err);
                alert('Failed to load languages.');
            });
        }

        const loadingMessageEl = document.getElementById('loading-message');
        const loadingElapsedEl = document.getElementById('loading-elapsed');
        const loadingCancelBtn = document.getElementById('loading-cancel');
        const errorBannerEl = document.getElementById('error-banner');
        const errorMessageEl = document.getElementById('error-message');
        const retryBtnEl = document.getElementById('retry-btn');
        let currentAbortController = null;
        let loadingTimer = null;
        let lastLearnSentence = '';
        let lastActionType = 'learn';

        const LOADING_PHASES = [
            { at: 0, msg: 'Translating...' },
            { at: 3, msg: 'Analyzing grammar...' },
            { at: 7, msg: 'Building word breakdown...' },
            { at: 12, msg: 'Adding pronunciation...' },
            { at: 18, msg: 'Almost there...' },
            { at: 25, msg: 'Still working ‚Äî complex sentence!' },
            { at: 35, msg: 'Hang tight, wrapping up...' },
        ];

        function startLoadingTimer() {
            const start = Date.now();
            loadingCancelBtn.style.display = 'none';
            loadingElapsedEl.textContent = '';
            loadingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - start) / 1000);
                loadingElapsedEl.textContent = elapsed + 's';
                // Progressive messages
                for (let i = LOADING_PHASES.length - 1; i >= 0; i--) {
                    if (elapsed >= LOADING_PHASES[i].at) {
                        loadingMessageEl.textContent = LOADING_PHASES[i].msg;
                        break;
                    }
                }
                // Show cancel after 8s
                if (elapsed >= 8) loadingCancelBtn.style.display = 'inline-block';
            }, 1000);
        }

        function stopLoadingTimer() {
            if (loadingTimer) { clearInterval(loadingTimer); loadingTimer = null; }
        }

        function showError(msg) {
            errorMessageEl.textContent = msg;
            errorBannerEl.style.display = 'block';
        }

        function hideError() { errorBannerEl.style.display = 'none'; }

        function closeCompareResults() {
            compareResultsEl.classList.add('hidden');
            compareResultsEl.innerHTML = '';
        }

        function renderCompareResults(data) {
            const results = Array.isArray(data.results) ? data.results : [];
            const originalSentence = data.sentence || sentenceInput.value.trim();
            const cardsHTML = results.map(entry => {
                const code = (entry.language || '').toLowerCase();
                const flag = LANG_FLAGS[code] || 'üåê';
                const languageName = entry.language_name || code.toUpperCase() || 'Language';
                const translation = entry.translation || 'No translation';
                const pronunciation = entry.pronunciation || 'Pronunciation unavailable';
                const literal = entry.literal || 'No literal translation';
                return `
                    <div class="compare-card">
                        <div class="compare-card-lang"><span class="flag">${flag}</span>${languageName}</div>
                        <div class="compare-card-translation">${translation}</div>
                        <div class="compare-card-pronunciation">${pronunciation}</div>
                        <div class="compare-card-literal">Literal: ${literal}</div>
                    </div>
                `;
            }).join('');

            compareResultsEl.innerHTML = `
                <div class="compare-results-head">
                    <div class="compare-results-label">Comparison mode</div>
                    <button type="button" class="compare-close-btn" id="compare-close-btn">‚úï Close</button>
                </div>
                <div class="compare-results-source">"${originalSentence}"</div>
                ${results.length ? `<div class="compare-grid">${cardsHTML}</div>` : '<div class="compare-empty">No comparison results returned.</div>'}
            `;
            const closeBtn = document.getElementById('compare-close-btn');
            if (closeBtn) closeBtn.addEventListener('click', closeCompareResults);
            compareResultsEl.classList.remove('hidden');
            compareResultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        loadingCancelBtn.addEventListener('click', () => {
            if (currentAbortController) currentAbortController.abort();
        });

        retryBtnEl.addEventListener('click', () => {
            hideError();
            if (lastLearnSentence) {
                sentenceInput.value = lastLearnSentence;
                if (lastActionType === 'compare') {
                    compareSentence();
                } else {
                    learn();
                }
            }
        });

        const LEARN_TIMEOUT_MS = 45000;

        function _hasMultipleSentences(text) {
            // Split on sentence terminators; if >1 non-empty part, it's multi
            const parts = text.split(/(?<=[.!?„ÄÇÔºÅÔºü])\s*/).filter(s => s.trim());
            return parts.length > 1;
        }

        async function learn() {
            if (!ensurePassword()) return;

            const sentence = sentenceInput.value.trim();
            if (!sentence) return;
            lastLearnSentence = sentence;
            lastActionType = 'learn';
            hideError();

            learnBtn.disabled = true;
            compareBtn.disabled = true;
            setRandomLoadingTip();
            loadingEl.classList.remove('hidden');
            startLoadingTimer();

            const isMulti = _hasMultipleSentences(sentence);
            if (isMulti) {
                loadingMessageEl.textContent = 'Translating multiple sentences...';
            } else {
                loadingMessageEl.textContent = 'Translating...';
            }

            currentAbortController = new AbortController();
            // Longer timeout for multi-sentence (2 min per sentence, max 10)
            const timeoutMs = isMulti ? Math.min(sentence.split(/(?<=[.!?„ÄÇÔºÅÔºü])\s*/).filter(s=>s.trim()).length, 10) * 120000 : LEARN_TIMEOUT_MS;
            const timeoutId = setTimeout(() => currentAbortController.abort(), timeoutMs);

            try {
                if (isMulti) {
                    // Multi-sentence path
                    const resp = await fetch('/api/learn-multi', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-App-Password': appPassword
                        },
                        body: JSON.stringify({
                            sentences: sentence,
                            target_language: langSelect.value, input_language: selectedInputLang,
                            speaker_gender: selectedGender,
                            speaker_formality: selectedFormality
                        }),
                        signal: currentAbortController.signal
                    });

                    clearTimeout(timeoutId);

                    if (resp.status === 401) {
                        localStorage.removeItem(PASSWORD_STORAGE_KEY);
                        appPassword = '';
                        openPasswordModal('Session expired. Enter password again.');
                        throw new Error('Unauthorized');
                    }
                    if (!resp.ok) throw new Error('API error');
                    const data = await resp.json();
                    const reqCtx = { target_language: langSelect.value, input_language: selectedInputLang, sentence: sentence };

                    // Render each result as a separate card
                    data.results.forEach(item => {
                        if (item.result) {
                            renderResult(item.result, item.sentence, { ...reqCtx, sentence: item.sentence });
                        }
                        // Skip errors silently (or could show inline)
                    });

                    saveSentenceToHistory(sentence);
                    // Add first result to rich history
                    if (data.results.length && data.results[0].result) {
                        const first = data.results[0];
                        addToRichHistory(sentence, first.result.translation, langSelect.value, first.result.pronunciation);
                    }
                    sentenceInput.value = '';
                    sentenceInput.style.height = 'auto';
                } else {
                    // Single sentence path (original)
                    const resp = await fetch('/api/learn', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-App-Password': appPassword
                        },
                        body: JSON.stringify({
                            sentence: sentence,
                            target_language: langSelect.value, input_language: selectedInputLang,
                            speaker_gender: selectedGender,
                            speaker_formality: selectedFormality
                        }),
                        signal: currentAbortController.signal
                    });

                    clearTimeout(timeoutId);

                    if (resp.status === 401) {
                        localStorage.removeItem(PASSWORD_STORAGE_KEY);
                        appPassword = '';
                        openPasswordModal('Session expired. Enter password again.');
                        throw new Error('Unauthorized');
                    }
                    if (!resp.ok) throw new Error('API error');
                    const data = await resp.json();
                    const reqCtx = { target_language: langSelect.value, input_language: selectedInputLang, sentence: sentence };
                    renderResult(data, sentence, reqCtx);
                    saveSentenceToHistory(sentence);
                    addToRichHistory(sentence, data.translation, langSelect.value, data.pronunciation);
                    sentenceInput.value = '';
                    sentenceInput.style.height = 'auto';
                }
            } catch (err) {
                clearTimeout(timeoutId);
                console.error(err);
                if (err.name === 'AbortError') {
                    showError('Request timed out ‚Äî the model might be busy. Tap retry.');
                } else if (err.message !== 'Unauthorized') {
                    showError('Something went wrong. Tap retry to try again.');
                }
            } finally {
                stopLoadingTimer();
                currentAbortController = null;
                if (appPassword === APP_PASSWORD) {
                    learnBtn.disabled = false;
                    compareBtn.disabled = false;
                } else {
                    lockApp();
                }
                loadingEl.classList.add('hidden');
            }
        }

        async function handleWordChipClick(chip, wordData, fullData, reqCtx) {
            // Toggle: if already expanded, collapse
            if (chip.classList.contains('expanded')) {
                chip.classList.remove('expanded');
                const detail = chip.querySelector('.word-detail');
                if (detail) detail.remove();
                return;
            }

            // Collapse any other expanded chips in the same card
            const parent = chip.closest('.word-chips');
            parent.querySelectorAll('.word-chip.expanded').forEach(other => {
                other.classList.remove('expanded');
                const d = other.querySelector('.word-detail');
                if (d) d.remove();
            });

            chip.classList.add('expanded');

            // Show loading
            const detailDiv = document.createElement('div');
            detailDiv.className = 'word-detail';
            detailDiv.innerHTML = '<div class="word-detail-loading">Loading details...</div>';
            chip.appendChild(detailDiv);

            try {
                const resp = await fetch('/api/word-detail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-App-Password': appPassword
                    },
                    body: JSON.stringify({
                        word: wordData.word,
                        meaning: wordData.meaning,
                        target_language: reqCtx.target_language,
                        sentence_context: fullData.translation
                    })
                });

                if (!resp.ok) throw new Error('API error');
                const detail = await resp.json();

                let html = '';

                // Example sentences
                if (detail.examples && detail.examples.length) {
                    html += '<div class="word-detail-section"><div class="word-detail-label">Examples</div><ul class="word-detail-examples">';
                    detail.examples.forEach(ex => {
                        html += `<li>${ex.sentence}<br><span class="example-pron">${ex.pronunciation || ''}</span> <span class="example-meaning">${ex.meaning}</span></li>`;
                    });
                    html += '</ul></div>';
                }

                // Conjugations
                if (detail.conjugations && detail.conjugations.length) {
                    html += '<div class="word-detail-section"><div class="word-detail-label">Forms</div><div class="word-detail-conjugations">';
                    detail.conjugations.forEach(c => {
                        html += `<span class="conjugation-tag">${c.form} <span class="conj-label">${c.label}</span></span>`;
                    });
                    html += '</div></div>';
                }

                // Related words
                if (detail.related && detail.related.length) {
                    html += '<div class="word-detail-section"><div class="word-detail-label">Related</div><div class="word-detail-related">';
                    detail.related.forEach(r => {
                        html += `<span class="related-word-tag" title="${r.meaning}">${r.word} ‚Äî ${r.meaning}</span>`;
                    });
                    html += '</div></div>';
                }

                detailDiv.innerHTML = html || '<div class="word-detail-loading">No additional details available.</div>';
            } catch (err) {
                console.error(err);
                detailDiv.innerHTML = '<div class="word-detail-loading">Failed to load details.</div>';
            }
        }

        function renderResult(data, original, reqCtx) {
            const card = document.createElement('div');
            card.className = 'result-card';

            const breakdownHTML = data.breakdown.map(w => `
                <div class="word-chip">
                    <div class="word-target">
                        <span class="difficulty-dot ${w.difficulty}"></span>
                        ${w.word}
                    </div>
                    <div class="word-pron">${w.pronunciation}</div>
                    <div class="word-meaning">${w.meaning}</div>
                    ${w.note ? `<div class="word-note">${w.note}</div>` : ''}
                </div>
            `).join('');

            const grammarHTML = data.grammar_notes.map(n => `<li>${n}</li>`).join('');

            card.innerHTML = `
                <div class="result-main">
                    <div class="result-source">"${original}"</div>
                    <div class="result-head">
                        <div class="result-translation">${data.translation}</div>
                        <button type="button" class="speak-btn" aria-label="Listen to pronunciation" data-lang="${langSelect.value}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" aria-hidden="true">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            </svg>
                            <span class="speak-label">Listen</span>
                        </button>
                        <button type="button" class="copy-btn" aria-label="Copy translation">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span class="copy-label">Copy</span>
                        </button>
                    </div>
                    <div class="result-pronunciation">${data.pronunciation}</div>
                    <div class="result-formality">${data.formality}</div>
                </div>
                <div class="breakdown-section">
                    <div class="section-title">Word Breakdown</div>
                    <div class="word-chips">${breakdownHTML}</div>
                </div>
                <div class="notes-section">
                    <div class="section-title">Grammar Notes</div>
                    <ul class="grammar-list">${grammarHTML}</ul>
                    ${data.cultural_note ? `<div class="cultural-note">üí° ${data.cultural_note}</div>` : ''}
                    ${data.alternative ? `<div class="alternative-note">üîÑ Alternative: ${data.alternative}</div>` : ''}
                    ${data.native_expression ? `<div class="cultural-note">üó£Ô∏è Native expression: ${data.native_expression}</div>` : ''}
                </div>
            `;

            // Clickable word chips
            card.querySelectorAll('.word-chip').forEach((chip, idx) => {
                const wordData = data.breakdown[idx];
                chip.addEventListener('click', () => handleWordChipClick(chip, wordData, data, reqCtx));
            });

            // Speak button
            const speakBtn = card.querySelector('.speak-btn');
            if (speakBtn) {
                speakBtn.addEventListener('click', () => {
                    speakTranslation(data.translation, speakBtn.dataset.lang, speakBtn);
                });
            }

            const copyBtn = card.querySelector('.copy-btn');
            const copyLabelEl = card.querySelector('.copy-label');
            copyBtn.addEventListener('click', async () => {
                const copied = await copyTextToClipboard(data.translation);
                copyLabelEl.textContent = copied ? 'Copied' : 'Failed';
                if (copied) {
                    copyBtn.classList.add('copied');
                }
                setTimeout(() => {
                    copyLabelEl.textContent = 'Copy';
                    copyBtn.classList.remove('copied');
                }, 1200);
            });

            // Prepend new result
            if (resultsEl.children.length > 0) {
                const divider = document.createElement('div');
                divider.className = 'history-divider';
                resultsEl.insertBefore(divider, resultsEl.firstChild);
            }
            resultsEl.insertBefore(card, resultsEl.firstChild);

            requestAnimationFrame(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }

        async function compareSentence() {
            if (!ensurePassword()) return;

            const sentence = sentenceInput.value.trim();
            if (!sentence) return;
            lastLearnSentence = sentence;
            lastActionType = 'compare';

            hideError();
            learnBtn.disabled = true;
            compareBtn.disabled = true;
            setRandomLoadingTip();
            loadingEl.classList.remove('hidden');
            loadingMessageEl.textContent = 'Comparing across languages...';
            startLoadingTimer();

            currentAbortController = new AbortController();
            const timeoutId = setTimeout(() => currentAbortController.abort(), LEARN_TIMEOUT_MS);

            try {
                const resp = await fetch('/api/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-App-Password': appPassword
                    },
                    body: JSON.stringify({
                        sentence: sentence,
                        input_language: selectedInputLang,
                        speaker_gender: selectedGender,
                        speaker_formality: selectedFormality
                    }),
                    signal: currentAbortController.signal
                });

                clearTimeout(timeoutId);

                if (resp.status === 401) {
                    localStorage.removeItem(PASSWORD_STORAGE_KEY);
                    appPassword = '';
                    openPasswordModal('Session expired. Enter password again.');
                    throw new Error('Unauthorized');
                }
                if (!resp.ok) throw new Error('API error');

                const data = await resp.json();
                renderCompareResults(data);
            } catch (err) {
                clearTimeout(timeoutId);
                console.error(err);
                if (err.name === 'AbortError') {
                    showError('Comparison timed out ‚Äî tap compare again.');
                } else if (err.message !== 'Unauthorized') {
                    showError('Could not compare this sentence right now.');
                }
            } finally {
                stopLoadingTimer();
                currentAbortController = null;
                if (appPassword === APP_PASSWORD) {
                    learnBtn.disabled = false;
                    compareBtn.disabled = false;
                } else {
                    lockApp();
                }
                loadingEl.classList.add('hidden');
            }
        }

        // === Surprise Me ===
        async function surpriseMe() {
            if (!ensurePassword()) return;
            const surpriseBtn = document.getElementById('surprise-btn');
            surpriseBtn.disabled = true;
            try {
                const lang = langSelect.value;
                const inputLang = selectedInputLang === 'auto' ? 'en' : selectedInputLang;
                const resp = await fetch(`/api/surprise?lang=${encodeURIComponent(lang)}&input_lang=${encodeURIComponent(inputLang)}`);
                if (!resp.ok) throw new Error('API error');
                const data = await resp.json();
                sentenceInput.value = data.sentence;
                sentenceInput.style.height = 'auto';
                sentenceInput.style.height = sentenceInput.scrollHeight + 'px';
                await learn();
            } catch (err) {
                console.error(err);
                alert('Could not fetch a surprise sentence.');
            } finally {
                surpriseBtn.disabled = false;
            }
        }

        // === Stories ===
        function toggleStoriesPanel() {
            storyPanelOpen = !storyPanelOpen;
            storiesPanelEl.classList.toggle('open', storyPanelOpen);
            storiesOverlayEl.classList.toggle('open', storyPanelOpen);
            if (storyPanelOpen) {
                renderStoriesBrowser();
            }
        }

        function closeStoriesPanel() {
            storyPanelOpen = false;
            storiesPanelEl.classList.remove('open');
            storiesOverlayEl.classList.remove('open');
        }

        async function loadStories() {
            try {
                const resp = await fetch('/api/stories');
                if (!resp.ok) return;
                stories = await resp.json();
                updateStoriesBadge();
            } catch (e) { console.error(e); }
        }

        function renderStoriesBrowser() {
            const selectedLang = langSelect.value;
            const langName = langSelect.options[langSelect.selectedIndex]?.textContent || selectedLang;
            const flag = LANG_FLAGS[selectedLang] || 'üåê';
            storiesFilterEl.textContent = `${flag} ${langName} stories`;

            const filtered = stories.filter(s => s.language === selectedLang);
            if (filtered.length === 0) {
                storiesListEl.innerHTML = '<div class="stories-empty">No stories for this language yet.</div>';
                return;
            }

            storiesListEl.innerHTML = filtered.map(s => {
                const prog = getStoryProgress(s.id, s.sentence_count);
                const progText = `${prog + 1}/${s.sentence_count}`;
                return `<button class="story-list-item" data-story-id="${s.id}">
                    <div class="story-list-title">${s.title}</div>
                    <div class="story-list-meta">
                        <span>${s.source}</span>
                        <span class="story-list-progress">${progText}</span>
                    </div>
                </button>`;
            }).join('');

            storiesListEl.querySelectorAll('.story-list-item').forEach(btn => {
                btn.addEventListener('click', () => openStoryReader(btn.dataset.storyId));
            });

            storiesBrowserEl.classList.remove('hidden');
            storyReaderEl.classList.add('hidden');
        }

        async function openStoryReader(storyId) {
            let story = storyCache[storyId];
            if (!story) {
                try {
                    const resp = await fetch(`/api/story/${encodeURIComponent(storyId)}`);
                    if (!resp.ok) return;
                    story = await resp.json();
                    storyCache[storyId] = story;
                } catch (e) { console.error(e); return; }
            }

            activeStory = story;
            activeStoryIndex = getStoryProgress(storyId, story.sentences.length);

            storiesBrowserEl.classList.add('hidden');
            storyReaderEl.classList.remove('hidden');
            renderStoryReader();
        }

        function renderStoryReader() {
            if (!activeStory) return;
            const total = activeStory.sentences.length;
            storyTitleEl.textContent = activeStory.title;
            storySourceEl.textContent = activeStory.source;
            storySentenceEl.textContent = activeStory.sentences[activeStoryIndex];
            storyProgressEl.textContent = `${activeStoryIndex + 1}/${total}`;
            storyPrevBtn.disabled = activeStoryIndex <= 0;
            storyNextBtn.disabled = activeStoryIndex >= total - 1;
        }

        storyPrevBtn.addEventListener('click', () => {
            if (!activeStory || activeStoryIndex <= 0) return;
            activeStoryIndex--;
            setStoryProgress(activeStory.id, activeStoryIndex);
            renderStoryReader();
        });

        storyNextBtn.addEventListener('click', () => {
            if (!activeStory || activeStoryIndex >= activeStory.sentences.length - 1) return;
            activeStoryIndex++;
            setStoryProgress(activeStory.id, activeStoryIndex);
            renderStoryReader();
        });

        // "Learn this sentence" ‚Äî clicking the story sentence fills input
        storySentenceEl.addEventListener('click', () => {
            if (!activeStory) return;
            const sentence = activeStory.sentences[activeStoryIndex];
            sentenceInput.value = sentence;
            sentenceInput.style.height = 'auto';
            sentenceInput.style.height = sentenceInput.scrollHeight + 'px';
            // Select the story's language
            selectLangPill(activeStory.language);
            closeStoriesPanel();
            sentenceInput.focus();
        });

        storyBackBtn.addEventListener('click', () => {
            activeStory = null;
            renderStoriesBrowser();
        });

        storiesToggleBtn.addEventListener('click', toggleStoriesPanel);
        storiesOverlayEl.addEventListener('click', closeStoriesPanel);
        storiesPanelCloseBtn.addEventListener('click', closeStoriesPanel);

        // Quiz mode event handlers
        quizToggleBtn.addEventListener('click', toggleQuizMode);
        quizCheckBtn.addEventListener('click', checkQuizAnswer);
        quizNextBtn.addEventListener('click', loadQuizQuestion);
        quizExitBtn.addEventListener('click', exitQuizMode);
        quizAnswerInputEl.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.isComposing) {
                e.preventDefault();
                checkQuizAnswer();
            }
        });

        // Load stories after languages load
        const origLoadLanguages = loadLanguages;
        loadLanguages = async function() {
            await origLoadLanguages();
            await loadStories();
        };
    </script>
</body>
</html>
